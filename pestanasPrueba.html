<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ELEMENTOS JSON</title>
  <link rel="stylesheet" href="pestanas.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .text-item {
      margin-bottom: 10px;
    }
    .text-item p {
      margin: 0;
    }
  
  </style>
</head>
<body>
  <h1>PDF -> EXCEL</h1>
  <button class= "btnExcel" onclick = "downloadExcel()"><img src="https://images.vexels.com/media/users/3/157561/isolated/preview/5077aba5e425c55dff227a93b655da7b-icono-de-descarga-simple.png">Descargar en xls (Excel)</button>
  <div id="text-output"></div>
  <script>
    //cargar el JSON
    fetch('./pdf.json')
      .then(response => {
        if (!response.ok) {
          throw new Error('ERROR de Respuesta');
        }
        return response.json();
      })
      .then(jsonData => {
        const textOutputDiv = document.getElementById('text-output');

        //FORMATO
        //verifico si el json y sus elementos existen
        if (jsonData && jsonData.elements) {
          let claveProveedor = 'TON23';
          //Inicializar variables para los encabezados y filas
          let headers = ['CLAVE PROVEEDOR','No.Factura','Fecha Factura','MONTO FACTURA','MONEDA', 'INCOTERM','SUBDIVISION','CERT. ORIGEN','NUMERO DE PARTE','PAIS ORIGEN','Description', 'Quantity', 'PRECIO', 'VALOR DE LA MERCANCIA', 'INVOICE NO.:'];
          let rows = []; 
          let invoiceNo = '';
          let numFactura= '';
          let fechaFactura = '';//Texto completo de fecha
          let fechaMod = ''//fecha
          let moneda = '';
          let monMod ='';
          let incoterm = '';
          //Recorrer cada elemento del JSON
          jsonData.elements.forEach(element => {
            let text = element.Text || '';
            let path = element.Path || '';

            //Verificar si el texto del elemento incluye ciertas cadenas para omitirlas.
            if (text.includes("NINGBO DYNACO HYDRAULIC CO., LTD.") ||
                    text.includes("HUILONG INDUSTRIAL ZONE 39,YIWU, JINHUA, ZHEJIANG PROVINCE, CHINA") ||
                    text.includes("TAX ID:") ||
                    text.includes("Commercial Invoice") ||
                    text.includes("To:") ||
                    text.includes("Attn:")){
                    return; //Salta este elemento y pasa al siguiente
            }
            
            if (path ==='//Document/Sect[2]/P[3]/Sub') {
              invoiceNo = element.Text || '';
              let long = invoiceNo.length;
              numFactura = invoiceNo.slice(12,long);
            }
            if(path === '//Document/Sect[2]/P[3]/Sub[3]'){
              fechaFactura = element.Text || '';
              let long = fechaFactura.length;
              fechaMod = fechaFactura.slice(9,long);
            }
            if(path.includes(`//Document/Sect[`) && path.includes(`]/Table/TR/TH[`)&& path.includes(`]/P`) && text.includes('USD')){
              moneda = element.Text || '';
              let long = moneda.length-2;
              monMod = moneda.slice(8, long);
            }
            if(path.includes(`//Document/Sect[2]/Table/TR[`) && path.includes(`]/TD[`)&& path.includes(`]/P`) && text.includes('CIF')){
              incoterm = element.Text;
            }
           
            //Aqui se procesaran los elementos que seran agregados a la tabla
            
            let row = {};
            if (path.includes(`]/TD[3]/P`)) {
              row['NUMERO DE PARTE'] = text;
            }else if (path.includes(`]/TD[2]/P`) && !text.includes('CIF')) {
              row['Description'] = text;
            }else if(path.includes(`]/TD[4]/P`) && !text.includes('PCS')){
              row['Quantity'] = text;
            }else if(path.includes(`]/TD[5]/P`)){
              row['PRICE (USD)'] = text;
            }else if(path.includes(`]/TD[6]/P`)){
              row['VALOR DE LA MERCANCIA'] = text;
            }else{return;}
            //SI PATH INCLUYE CIERTO CONTENIDO PARA EL TEXT
            //if ((path.includes(`//Document/Sect[2]/Table/TR[`) && path.includes(`]/TD[`) && path.includes(`]/P`)) || path.includes(`//Document/Sect[2]/P[3]/Sub`)) {
            headers.forEach(header =>{
              if(header === "CLAVE PROVEEDOR"){
                row[header] = claveProveedor;
              }
              if (header === "No.Factura"){
                row[header] = numFactura;
              }else if(header === "Fecha Factura"){
                row[header] = fechaMod;
              }else if(header === "MONEDA"){
                row[header] = monMod;
              }else if(header === "INCOTERM"){
                row[header] = incoterm;
              }
            });
             //row['No. de Factura'] = invoiceNo;
            console.log(path);
            rows.push(row);
            
          });
          //creacion de la tabla
          let tableHTML = `
            <table id="dataTable" class = "tablaDatos">
              <thead>
                <tr>
                  <th>CLAVE PROVEEDOR</th>
                  <th>No.Factura</th>
                  <th>Fecha Factura</th>
                  <th>MONTO FACTURA</th>
                  <th>MONEDA</th>
                  <th>INCOTERM</th>
                  <th>SUBDIVISION</th>
                  <th>CERT. ORIGEN</th>
                  <th>NUMERO DE PARTE</th>
                  <th>PAIS ORIGEN</th>
                  <th>Descripcion</th>
                  <th>Cantidad</th>
                  <th>Precio (USD)</th>
                  <th>VALOR DE LA MERCANCIA</th>
                </tr>
              </thead>
              <tbody>`;
          //agregar filas a la tabla
          rows.forEach(row => {
            tableHTML += `
              <tr>
                <td>${row['CLAVE PROVEEDOR'] || ''}</td>
                <td>${row['No.Factura'] || ''}</td>
                <td>${row['Fecha Factura'] || ''}</td>
                <td>${row['MONTO FACTURA'] || ''}</td>
                <td>${row['MONEDA'] || ''}</td>
                <td>${row['INCOTERM'] || ''}</td>
                <td>${row['SUBDIVISION'] || ''}</td>
                <td>${row['CERT. ORIGEN'] || ''}</td>
                <td>${row['NUMERO DE PARTE'] || ''}</td>
                <td>${row['PAIS ORIGEN'] || ''}</td>
                <td>${row['Description'] || ''}</td>
                <td>${row['Quantity'] || ''}</td>
                <td>${row['PRICE (USD)'] || ''}</td>
                <td>${row['VALOR DE LA MERCANCIA'] || ''}</td>
              </tr>
            `;
          });
          //cerrar las etiquetas de la tabla
          tableHTML += `
              </tbody>
            </table>
          `;
          //insertar la tabla en el contenedor
          textOutputDiv.innerHTML = tableHTML;
        } else {
          textOutputDiv.innerHTML = '<p>No elements found in JSON data.</p>';
        }
      })
      .catch(error => {
        console.error('Error fetching JSON:', error);
        document.getElementById('text-output').innerHTML = '<p>Error loading JSON data.</p>';
      });

      // Función para descargar la tabla como Excel
    function htmlExcel(idTabla, nombreArchivo = '') {
      let linkDescarga;
      let tipoDatos = 'application/vnd.ms-excel';
      let tablaDatos = document.getElementById(idTabla);
      let tablaHTML = tablaDatos.outerHTML.replace(/ /g, '%20');

      // Nombre del archivo
      nombreArchivo = nombreArchivo ? nombreArchivo + '.xls' : 'archivo.xlsx';

      // Crear el link de descarga
      linkDescarga = document.createElement("a");

      document.body.appendChild(linkDescarga);

      if (navigator.msSaveOrOpenBlob) {
        let blob = new Blob(['\ufeff', tablaHTML], {
          type: tipoDatos
        });
        navigator.msSaveOrOpenBlob(blob, nombreArchivo);
      } else {
        // Crear el link al archivo
        linkDescarga.href = 'data:' + tipoDatos + ', ' + tablaHTML;

        // Setear el nombre de archivo
        linkDescarga.download = nombreArchivo;

        //Ejecutar la función
        linkDescarga.click();
      }
    }

    function downloadExcel() {
      htmlExcel('dataTable', 'Datos_JSON');
    }
  </script>
</body>
</html>

